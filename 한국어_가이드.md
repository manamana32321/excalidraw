# Excalidraw 쿠버네티스 배포 가이드

## 개요

온프레미스 쿠버네티스 클러스터에 Excalidraw를 배포하기 위한 가이드입니다.
공식 Excalidraw Docker 이미지를 사용하여 간단하게 배포할 수 있습니다.

## 구현된 기능

### 배포 구성 요소

1. **클라이언트** - 공식 Excalidraw 웹 애플리케이션 (`excalidraw/excalidraw:latest`)
2. **서버** - .excalidraw 파일 저장소 (nginx 기반)
3. **소켓 서버** (선택사항) - 실시간 협업 (`excalidraw/excalidraw-room:latest`)

### 주요 특징

✅ 공식 Docker 이미지 사용으로 빌드 불필요
✅ .excalidraw 파일이 ingress를 통해 `/files` 엔드포인트로 외부 노출
✅ 10Gi PersistentVolume을 사용한 영구 스토리지
✅ 언제든지 파일에 접근 가능
✅ ArgoCD를 통한 GitOps 배포 준비 완료

## 파일 구조

```
excalidraw/
├── README.md                  # 전체 배포 가이드 (영문)
├── QUICKSTART.md             # 빠른 시작 가이드 (영문)
├── ARCHITECTURE.md           # 시스템 아키텍처 문서
├── DEPLOYMENT_SUMMARY.md     # 배포 요약
├── 한국어_가이드.md           # 이 파일
├── Makefile                  # 배포 자동화 도구
├── deploy.sh                 # 쿠버네티스 배포 스크립트
├── .gitignore               # Git 제외 파일 설정
│
├── k8s/
│   ├── base/
│   │   ├── namespace.yaml        # excalidraw 네임스페이스
│   │   ├── configmap.yaml        # 설정 파일
│   │   ├── pvc.yaml              # 10Gi 영구 볼륨
│   │   ├── ingress.yaml          # 외부 접근 설정
│   │   └── kustomization.yaml    # Kustomize 설정
│   │
│   ├── client/
│   │   ├── deployment.yaml      # 클라이언트 배포 (공식 이미지 사용)
│   │   └── service.yaml         # 클라이언트 서비스
│   │
│   ├── server/
│   │   ├── deployment.yaml      # 서버 배포 (nginx 이미지)
│   │   └── service.yaml         # 서버 서비스
│   │
│   └── socket/
│       ├── deployment.yaml      # 소켓 배포 (공식 이미지 사용)
│       └── service.yaml         # 소켓 서비스
│
├── argocd-example/
│   ├── README.md                        # ArgoCD 문서
│   ├── application.yaml                 # 기본 ArgoCD 앱
│   └── application-with-socket.yaml     # 소켓 포함 ArgoCD 앱
│
└── examples/
    ├── README.md                # 예제 파일 사용 가이드
    └── sample.excalidraw        # 샘플 파일
```

## 배포 방법

### 1. 설정 변경

배포 전에 다음 파일들을 수정하세요:

```bash
# 도메인 설정
vi k8s/base/ingress.yaml
# excalidraw.json-server.win을 실제 도메인으로 변경
# excalidraw.json-server.win을 실제 도메인으로 변경

# URL 설정
vi k8s/base/configmap.yaml
# VITE_APP_WS_SERVER_URL과 VITE_APP_HTTP_STORAGE_BACKEND_URL 변경

# 스토리지 클래스 설정 (필요시)
vi k8s/base/pvc.yaml
# storageClassName 주석 해제 및 설정
```

### 2. 쿠버네티스 배포

### 2. 쿠버네티스 배포

```bash
# 방법 1: 배포 스크립트 사용 (권장)
./deploy.sh

# 방법 2: Makefile 사용
make deploy

# 방법 3: Kustomize 사용
kubectl apply -k k8s/base/

# 방법 4: 수동 배포 (순서대로)
kubectl apply -f k8s/base/namespace.yaml
kubectl apply -f k8s/base/pvc.yaml
kubectl apply -f k8s/base/configmap.yaml
kubectl apply -f k8s/client/deployment.yaml
kubectl apply -f k8s/client/service.yaml
kubectl apply -f k8s/server/deployment.yaml
kubectl apply -f k8s/server/service.yaml
kubectl apply -f k8s/base/ingress.yaml

# 소켓 서버 (선택사항)
kubectl apply -f k8s/socket/deployment.yaml
kubectl apply -f k8s/socket/service.yaml
```

**참고**: 공식 Docker 이미지를 사용하므로 별도의 이미지 빌드가 필요하지 않습니다.

### 3. 배포 상태 확인

```bash
# 방법 1: Makefile 사용
make status

# 방법 2: kubectl 직접 사용
kubectl get all -n excalidraw
kubectl get ingress -n excalidraw
kubectl get pvc -n excalidraw
```

### 4. DNS 설정

```bash
# Ingress IP 확인
kubectl get ingress -n excalidraw

# DNS A 레코드 추가
# your-domain.com → <Ingress IP>
```

## 접근 방법

### 웹 UI

```
https://your-domain.com/
```

### 파일 브라우저

```
https://your-domain.com/files/
```

### 특정 파일 접근

```
https://your-domain.com/files/myfile.excalidraw
```

## 파일 업로드

### kubectl을 사용한 업로드

```bash
# Pod 이름 확인
POD=$(kubectl get pod -n excalidraw -l component=server -o jsonpath='{.items[0].metadata.name}')

# 파일 복사
kubectl cp myfile.excalidraw $POD:/data/excalidraw/ -n excalidraw

# 또는 직접 업로드
kubectl exec -n excalidraw $POD -- \
  sh -c "cat > /data/excalidraw/myfile.excalidraw" < myfile.excalidraw
```

### 디렉토리 구성

```bash
# 서버 Pod에 디렉토리 생성
kubectl exec -n excalidraw deployment/excalidraw-server -- \
  mkdir -p /data/excalidraw/projects /data/excalidraw/drafts

# 디렉토리별로 파일 업로드
kubectl cp myfile.excalidraw $POD:/data/excalidraw/projects/ -n excalidraw
```

## ArgoCD 통합 (manamana32321/homelab)

homelab 레포지토리에 다음과 같이 설정:

```yaml
# homelab/apps/excalidraw/application.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: excalidraw
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/manamana32321/excalidraw
    targetRevision: main
    path: k8s/base
  destination:
    server: https://kubernetes.default.svc
    namespace: excalidraw
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - CreateNamespace=true
```

배포:

```bash
kubectl apply -f apps/excalidraw/application.yaml
```

## 유용한 명령어

### 로그 확인

```bash
make logs                    # 모든 로그
make logs-client            # 클라이언트 로그만
make logs-server            # 서버 로그만
make logs-socket            # 소켓 로그만
```

### 재시작

```bash
make restart                # 모든 배포 재시작
make restart-client         # 클라이언트만
make restart-server         # 서버만
make restart-socket         # 소켓만
```

### 포트 포워딩 (로컬 테스트)

```bash
make port-forward-client    # localhost:8080
make port-forward-server    # localhost:8081
make port-forward-socket    # localhost:3002
```

### 정리

```bash
make clean                  # 모든 리소스 삭제
```

## 문제 해결

### Pod가 시작하지 않음

```bash
kubectl describe pod <pod-name> -n excalidraw
kubectl logs <pod-name> -n excalidraw
```

### 스토리지 문제

```bash
kubectl get pvc -n excalidraw
kubectl describe pvc excalidraw-storage-pvc -n excalidraw
```

### Ingress가 작동하지 않음

```bash
kubectl describe ingress excalidraw-ingress -n excalidraw
kubectl get ingress -n excalidraw -o wide
```

### 이미지를 가져올 수 없음

```bash
# Pod 상태 확인
kubectl describe pod <pod-name> -n excalidraw

# 공식 이미지를 사용하므로 Docker Hub에서 자동으로 가져옵니다
# 프라이빗 레지스트리를 사용하는 경우 imagePullSecrets 설정 필요
```

## 특징 요약

✅ **배포 순서 준수**

- 클라이언트 → 서버 → 소켓 (선택)
  ✅ **공식 이미지 사용**

- excalidraw/excalidraw:latest (클라이언트)
- nginx:alpine (파일 서버)
- excalidraw/excalidraw-room:latest (협업 서버)

✅ **빌드 불필요**

- Docker 이미지 빌드 과정 생략
- 바로 배포 가능

✅ **파일 접근성**

- 모든 .excalidraw 파일이 ingress를 통해 외부 노출
- /files 엔드포인트로 언제든지 접근 가능

- 모든 .excalidraw 파일이 ingress를 통해 외부 노출
- /files 엔드포인트로 언제든지 접근 가능

✅ **영구 스토리지**

- 10Gi PersistentVolume
- 파일 영구 보관

- 10Gi PersistentVolume
- 파일 영구 보관

✅ **완전한 문서화**

- 4개의 상세 가이드 문서
- 예제 파일 및 사용법

- 4개의 상세 가이드 문서
- 예제 파일 및 사용법

✅ **자동화 도구**

- Makefile (20+ 명령어)
- 빌드/배포 스크립트
- Kustomize 지원

- Makefile (20+ 명령어)
- 빌드/배포 스크립트
- Kustomize 지원

✅ **GitOps 준비**

- ArgoCD 통합 예제
- homelab 레포지토리 연동 가능

- ArgoCD 통합 예제
- homelab 레포지토리 연동 가능

✅ **프로덕션 준비**

- Health check 설정
- 리소스 제한 설정
- CORS 지원
- 보안 헤더 설정

- Health check 설정
- 리소스 제한 설정
- CORS 지원
- 보안 헤더 설정

## 다음 단계

1. **설정 파일 수정** (도메인, 스토리지 클래스)
2. **클러스터에 배포** (`make deploy` 또는 `./deploy.sh`)
3. **DNS 설정** (ingress IP로)
4. **브라우저에서 접근** 확인

배포 시 공식 Docker 이미지가 자동으로 다운로드되므로 별도의 빌드 과정이 필요하지 않습니다.

## 지원

더 자세한 정보는 다음 문서를 참조하세요:

- `README.md` - 전체 배포 가이드 (영문)
- `QUICKSTART.md` - 빠른 시작 (영문)
- `ARCHITECTURE.md` - 아키텍처 상세
- `examples/README.md` - 예제 파일 사용법

모든 YAML 파일이 검증되었으며 프로덕션에 사용할 준비가 되었습니다.
