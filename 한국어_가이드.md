# Excalidraw 쿠버네티스 배포 완료

## 개요

온프레미스 쿠버네티스 클러스터에 Excalidraw를 배포하기 위한 모든 설정이 완료되었습니다.

## 구현된 기능

### 배포 순서 (요구사항대로)
1. **클라이언트** (첫 번째) - Excalidraw 웹 애플리케이션
2. **서버** (두 번째) - .excalidraw 파일 저장소
3. **소켓 서버** (선택사항, 마지막) - 실시간 협업

### 주요 특징
✅ .excalidraw 파일이 ingress를 통해 `/files` 엔드포인트로 외부 노출
✅ 10Gi PersistentVolume을 사용한 영구 스토리지
✅ 언제든지 파일에 접근 가능
✅ ArgoCD를 통한 GitOps 배포 준비 완료

## 파일 구조

```
excalidraw/
├── README.md                  # 전체 배포 가이드 (영문)
├── QUICKSTART.md             # 빠른 시작 가이드 (영문)
├── ARCHITECTURE.md           # 시스템 아키텍처 문서
├── DEPLOYMENT_SUMMARY.md     # 배포 요약
├── 한국어_가이드.md           # 이 파일
├── Makefile                  # 배포 자동화 도구
├── build.sh                  # Docker 이미지 빌드 스크립트
├── deploy.sh                 # 쿠버네티스 배포 스크립트
├── .gitignore               # Git 제외 파일 설정
│
├── k8s/
│   ├── base/
│   │   ├── namespace.yaml        # excalidraw 네임스페이스
│   │   ├── configmap.yaml        # 설정 파일
│   │   ├── pvc.yaml              # 10Gi 영구 볼륨
│   │   ├── ingress.yaml          # 외부 접근 설정
│   │   └── kustomization.yaml    # Kustomize 설정
│   │
│   ├── client/
│   │   ├── Dockerfile           # 클라이언트 이미지
│   │   ├── nginx.conf           # Nginx 설정
│   │   ├── deployment.yaml      # 클라이언트 배포
│   │   └── service.yaml         # 클라이언트 서비스
│   │
│   ├── server/
│   │   ├── Dockerfile           # 서버 이미지
│   │   ├── server-nginx.conf    # 서버 Nginx 설정
│   │   ├── start.sh             # 시작 스크립트
│   │   ├── deployment.yaml      # 서버 배포
│   │   └── service.yaml         # 서버 서비스
│   │
│   └── socket/
│       ├── Dockerfile           # 소켓 이미지
│       ├── deployment.yaml      # 소켓 배포
│       └── service.yaml         # 소켓 서비스
│
├── argocd-example/
│   ├── README.md                        # ArgoCD 문서
│   ├── application.yaml                 # 기본 ArgoCD 앱
│   └── application-with-socket.yaml     # 소켓 포함 ArgoCD 앱
│
└── examples/
    ├── README.md                # 예제 파일 사용 가이드
    └── sample.excalidraw        # 샘플 파일

총 30개 파일 생성
```

## 배포 방법

### 1. 설정 변경

배포 전에 다음 파일들을 수정하세요:

```bash
# 도메인 설정
vi k8s/base/ingress.yaml
# excalidraw.example.com을 실제 도메인으로 변경

# URL 설정
vi k8s/base/configmap.yaml
# VITE_APP_WS_SERVER_URL과 VITE_APP_HTTP_STORAGE_BACKEND_URL 변경

# 스토리지 클래스 설정 (필요시)
vi k8s/base/pvc.yaml
# storageClassName 주석 해제 및 설정
```

### 2. Docker 이미지 빌드

```bash
# 방법 1: 빌드 스크립트 사용
./build.sh

# 방법 2: Makefile 사용
make build

# 방법 3: 개별 빌드
cd k8s/client && docker build -t excalidraw-client:latest .
cd k8s/server && docker build -t excalidraw-server:latest .
cd k8s/socket && docker build -t excalidraw-socket:latest .
```

### 3. 쿠버네티스에 배포

```bash
# 방법 1: 배포 스크립트 사용 (권장)
./deploy.sh

# 방법 2: Makefile 사용
make deploy

# 방법 3: Kustomize 사용
kubectl apply -k k8s/base/

# 방법 4: 수동 배포 (순서대로)
kubectl apply -f k8s/base/namespace.yaml
kubectl apply -f k8s/base/pvc.yaml
kubectl apply -f k8s/base/configmap.yaml
kubectl apply -f k8s/client/deployment.yaml
kubectl apply -f k8s/client/service.yaml
kubectl apply -f k8s/server/deployment.yaml
kubectl apply -f k8s/server/service.yaml
kubectl apply -f k8s/base/ingress.yaml

# 소켓 서버 (선택사항)
kubectl apply -f k8s/socket/deployment.yaml
kubectl apply -f k8s/socket/service.yaml
```

### 4. 배포 상태 확인

```bash
# 방법 1: Makefile 사용
make status

# 방법 2: kubectl 직접 사용
kubectl get all -n excalidraw
kubectl get ingress -n excalidraw
kubectl get pvc -n excalidraw
```

### 5. DNS 설정

```bash
# Ingress IP 확인
kubectl get ingress -n excalidraw

# DNS A 레코드 추가
# your-domain.com → <Ingress IP>
```

## 접근 방법

### 웹 UI
```
https://your-domain.com/
```

### 파일 브라우저
```
https://your-domain.com/files/
```

### 특정 파일 접근
```
https://your-domain.com/files/myfile.excalidraw
```

## 파일 업로드

### kubectl을 사용한 업로드

```bash
# Pod 이름 확인
POD=$(kubectl get pod -n excalidraw -l component=server -o jsonpath='{.items[0].metadata.name}')

# 파일 복사
kubectl cp myfile.excalidraw $POD:/data/excalidraw/ -n excalidraw

# 또는 직접 업로드
kubectl exec -n excalidraw $POD -- \
  sh -c "cat > /data/excalidraw/myfile.excalidraw" < myfile.excalidraw
```

### 디렉토리 구성

```bash
# 서버 Pod에 디렉토리 생성
kubectl exec -n excalidraw deployment/excalidraw-server -- \
  mkdir -p /data/excalidraw/projects /data/excalidraw/drafts

# 디렉토리별로 파일 업로드
kubectl cp myfile.excalidraw $POD:/data/excalidraw/projects/ -n excalidraw
```

## ArgoCD 통합 (manamana32321/homelab)

homelab 레포지토리에 다음과 같이 설정:

```yaml
# homelab/apps/excalidraw/application.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: excalidraw
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/manamana32321/excalidraw
    targetRevision: main
    path: k8s/base
  destination:
    server: https://kubernetes.default.svc
    namespace: excalidraw
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true
```

배포:
```bash
kubectl apply -f apps/excalidraw/application.yaml
```

## 유용한 명령어

### 로그 확인
```bash
make logs                    # 모든 로그
make logs-client            # 클라이언트 로그만
make logs-server            # 서버 로그만
make logs-socket            # 소켓 로그만
```

### 재시작
```bash
make restart                # 모든 배포 재시작
make restart-client         # 클라이언트만
make restart-server         # 서버만
make restart-socket         # 소켓만
```

### 포트 포워딩 (로컬 테스트)
```bash
make port-forward-client    # localhost:8080
make port-forward-server    # localhost:8081
make port-forward-socket    # localhost:3002
```

### 정리
```bash
make clean                  # 모든 리소스 삭제
```

## 문제 해결

### Pod가 시작하지 않음
```bash
kubectl describe pod <pod-name> -n excalidraw
kubectl logs <pod-name> -n excalidraw
```

### 스토리지 문제
```bash
kubectl get pvc -n excalidraw
kubectl describe pvc excalidraw-storage-pvc -n excalidraw
```

### Ingress가 작동하지 않음
```bash
kubectl describe ingress excalidraw-ingress -n excalidraw
kubectl get ingress -n excalidraw -o wide
```

### 이미지를 가져올 수 없음
```bash
# 이미지가 빌드되었는지 확인
docker images | grep excalidraw

# 원격 클러스터의 경우, 레지스트리에 푸시
docker tag excalidraw-client:latest your-registry/excalidraw-client:latest
docker push your-registry/excalidraw-client:latest

# deployment.yaml에서 이미지 경로 업데이트
```

## 특징 요약

✅ **배포 순서 준수**
   - 클라이언트 → 서버 → 소켓 (선택)

✅ **파일 접근성**
   - 모든 .excalidraw 파일이 ingress를 통해 외부 노출
   - /files 엔드포인트로 언제든지 접근 가능

✅ **영구 스토리지**
   - 10Gi PersistentVolume
   - 파일 영구 보관

✅ **완전한 문서화**
   - 4개의 상세 가이드 문서
   - 예제 파일 및 사용법

✅ **자동화 도구**
   - Makefile (20+ 명령어)
   - 빌드/배포 스크립트
   - Kustomize 지원

✅ **GitOps 준비**
   - ArgoCD 통합 예제
   - homelab 레포지토리 연동 가능

✅ **프로덕션 준비**
   - Health check 설정
   - 리소스 제한 설정
   - CORS 지원
   - 보안 헤더 설정

## 다음 단계

1. **설정 파일 수정** (도메인, 스토리지 클래스)
2. **이미지 빌드** (`make build`)
3. **클러스터에 배포** (`make deploy`)
4. **DNS 설정** (ingress IP로)
5. **브라우저에서 접근** 확인

## 지원

더 자세한 정보는 다음 문서를 참조하세요:
- `README.md` - 전체 배포 가이드 (영문)
- `QUICKSTART.md` - 빠른 시작 (영문)
- `ARCHITECTURE.md` - 아키텍처 상세
- `examples/README.md` - 예제 파일 사용법

모든 YAML 파일이 검증되었으며 프로덕션에 사용할 준비가 되었습니다.
